<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Mission - ZENOA</title>
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap"
        rel="stylesheet">
    <style>
        .option-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s var(--ease-out);
            position: relative;
            overflow: hidden;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }

        .option-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--gold-primary);
            transform: translateX(10px);
        }

        .option-btn.selected {
            background: var(--gold-primary);
            color: #000;
            border-color: var(--gold-primary);
            box-shadow: 0 0 20px var(--gold-glow);
            font-weight: 700;
        }

        .scenario-text {
            font-family: var(--font-display);
            font-size: 1.8rem;
            line-height: 1.4;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }
    </style>
</head>

<body style="overflow-y: auto;">
    <div class="overlay"></div>

    <!-- Cinematic Container -->
    <div class="container"
        style="max-width: 800px; padding-top: 2rem; min-height: 100vh; display: flex; flex-direction: column;">

        <!-- TOP HUD -->
        <div class="flex-between"
            style="margin-bottom: 3rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
            <div class="flex-center" style="gap: 1rem;">
                <span id="category-badge" class="badge badge-tier-legend"
                    style="font-size: 0.7rem; animation: glow-pulse 3s infinite;">LOADING...</span>
                <div style="height: 2px; width: 100px; background: rgba(255,255,255,0.1);">
                    <div id="progress-bar-top"
                        style="height: 100%; width: 0%; background: var(--neon-blue); box-shadow: 0 0 10px var(--neon-blue-glow); transition: width 0.5s;">
                    </div>
                </div>
            </div>

            <div id="timer"
                style="font-family: var(--font-display); font-size: 1.5rem; color: #ff4444; text-shadow: 0 0 10px rgba(255, 0, 0, 0.5); letter-spacing: 2px;">
                LIVE
            </div>
        </div>

        <!-- MAIN CARD -->
        <div class="card-glass"
            style="flex: 1; display: flex; flex-direction: column; justify-content: center; border: none; background: transparent; box-shadow: none;">

            <h2 id="scenario-text" class="scenario-text" style="color: #fff; margin-bottom: 3rem; min-height: 120px;">
                Initializing scenario parameters...
            </h2>

            <div id="options-container">
                <!-- JS Injected -->
            </div>

            <p id="error-msg"
                style="color: #ff4444; text-align: center; margin-top: 1rem; font-family: var(--font-ui); text-transform: uppercase; letter-spacing: 1px;">
            </p>
        </div>

        <!-- CONTROLS -->
        <div id="next-btn-container"
            style="margin-top: 2rem; margin-bottom: 4rem; text-align: center; opacity: 0; transition: opacity 0.5s;">
            <button id="next-btn" class="btn btn-primary" style="padding: 1.2rem 4rem; font-size: 1.2rem; width: 100%;">
                CONFIRM PROTOCOL
            </button>
        </div>

    </div>

    <script type="module">
        import { auth } from './js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { subscribeToGame, submitAnswer, nextQuestion } from './js/game.js';
        import { QUESTIONS_DB } from './js/data.js';

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');

        if (!roomId) window.location.href = 'dashboard.html';

        let currentUser = null;
        let currentRoomData = null;
        let localCurrentIndex = 0;
        let totalQuestions = 0;

        initGameListener();

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                currentUser = user;
                if (currentRoomData) {
                    renderQuestion(currentRoomData);
                }
            }
        });

        function initGameListener() {
            subscribeToGame(roomId, (roomData) => {
                if (!roomData) return;
                currentRoomData = roomData;
                totalQuestions = roomData.questionQueue ? roomData.questionQueue.length : 0;
                renderQuestion(roomData);
            });
        }

        function renderQuestion(roomData) {
            const index = localCurrentIndex;

            if (!roomData.questionQueue || roomData.questionQueue.length === 0) {
                document.getElementById('scenario-text').textContent = "Error: Empty mission parameters.";
                return;
            }

            if (index >= totalQuestions) {
                document.body.style.opacity = '0';
                setTimeout(() => { window.location.href = `results.html?roomId=${roomId}`; }, 500);
                return;
            }

            const qId = roomData.questionQueue[index];
            const question = QUESTIONS_DB.find(q => q.id === qId);

            if (!question) {
                document.getElementById('scenario-text').textContent = "Data corruption detected. Skip to next.";
                document.getElementById('next-btn-container').style.opacity = '1';
                return;
            }

            // Update UI
            document.getElementById('category-badge').textContent = (question.category || "GENERAL").toUpperCase();
            const progress = ((index + 1) / totalQuestions) * 100;
            document.getElementById('progress-bar-top').style.width = `${progress}%`;

            document.getElementById('scenario-text').textContent = question.scenario;

            // Checked saved answer
            let savedAnswer = undefined;
            if (currentUser && roomData.answers && roomData.answers[currentUser.uid]) {
                savedAnswer = roomData.answers[currentUser.uid][String(qId)];
            }

            // Options
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            question.options.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.style.animation = `float 0.5s ease-out ${i * 0.1}s backwards`; // Staggered entrance

                if (savedAnswer === i) {
                    btn.classList.add('selected');
                }

                btn.onclick = async () => {
                    if (!currentUser) return;

                    const allBtns = container.querySelectorAll('.option-btn');
                    allBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');

                    try {
                        await submitAnswer(roomId, currentUser.uid, qId, i);
                        const nextBtnContainer = document.getElementById('next-btn-container');
                        nextBtnContainer.style.opacity = '1';
                        nextBtnContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } catch (e) {
                        document.getElementById('error-msg').textContent = "TRANSMISSION FAILED. RETRY.";
                    }
                };
                container.appendChild(btn);
            });

            if (savedAnswer !== undefined) {
                document.getElementById('next-btn-container').style.opacity = '1';
            } else {
                document.getElementById('next-btn-container').style.opacity = '0';
            }
        }

        document.getElementById('next-btn').addEventListener('click', () => {
            localCurrentIndex++;
            window.scrollTo(0, 0);
            renderQuestion(currentRoomData);
        });
    </script>
</body>

</html>