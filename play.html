<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing - ZENOA</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .option-btn {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 1rem;
            text-align: left;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .option-btn:hover {
            background-color: var(--surface-hover);
            border-color: var(--accent-color);
        }

        .option-btn.selected {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
    </style>
</head>

<body>
    <div class="container" style="max-width: 800px; padding-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div style="font-weight: 700; color: var(--text-secondary);">ZENOA</div>
            <div id="timer" style="font-variant-numeric: tabular-nums; font-weight: 700; font-size: 1.2rem;">30s</div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <span id="category-badge"
                    style="background: var(--surface-hover); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; text-transform: uppercase;">...</span>
                <span id="progress-indicator">1 / 8</span>
            </div>

            <h2 id="scenario-text" style="font-size: 1.5rem; margin-bottom: 2rem; line-height: 1.4;">Loading scenario...
            </h2>

            <div id="options-container" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Options injected here -->
            </div>
        </div>

        <div id="host-controls" class="hidden" style="margin-top: 2rem; text-align: center;">
            <p style="margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">Host Controls</p>
            <button id="next-btn" class="btn btn-primary" style="padding: 0.5rem 2rem;">Next Question</button>
        </div>
        <p id="waiting-msg" class="hidden"
            style="text-align: center; margin-top: 2rem; color: var(--text-secondary); font-style: italic;">Waiting for
            others...</p>
    </div>

    <script type="module">
        import { auth } from './js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { subscribeToGame, submitAnswer, nextQuestion } from './js/game.js';
        import { QUESTIONS_DB } from './js/data.js';

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');

        if (!roomId) window.location.href = 'dashboard.html';

        let currentUser = null;
        let currentRoomData = null;
        let selectedOption = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                currentUser = user;
                initGameListener();
            }
        });

        function initGameListener() {
            subscribeToGame(roomId, (roomData) => {
                if (!roomData) return;
                currentRoomData = roomData;

                if (roomData.status === 'finished') {
                    window.location.href = `results.html?roomId=${roomId}`;
                    return;
                }

                renderQuestion(roomData);

                // Show Host Controls
                if (currentUser.uid === roomData.hostId) {
                    document.getElementById('host-controls').classList.remove('hidden');
                } else {
                    document.getElementById('waiting-msg').classList.remove('hidden');
                }
            });
        }

        function renderQuestion(roomData) {
            const index = roomData.currentQuestionIndex || 0;
            const qId = roomData.questionQueue[index];
            const question = QUESTIONS_DB.find(q => q.id === qId);

            if (!question) return;

            // Update UI
            document.getElementById('category-badge').textContent = question.category;
            document.getElementById('progress-indicator').textContent = `${index + 1} / ${roomData.questionQueue.length}`;
            document.getElementById('scenario-text').textContent = question.scenario;

            // Render Options
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            // Checks if user already answered
            const userAnswers = roomData.answers && roomData.answers[currentUser.uid];
            const savedAnswer = userAnswers ? userAnswers[qId] : null;

            question.options.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = opt;

                if (savedAnswer !== undefined && savedAnswer === i) {
                    btn.classList.add('selected');
                }

                btn.onclick = () => {
                    if (savedAnswer !== undefined) return; // Prevent changing? Or allow? Let's allow for now.
                    // Actually for MVP, let's just select
                    selectOption(i, qId);
                };

                container.appendChild(btn);
            });
        }

        async function selectOption(index, qId) {
            // Optimistic UI
            const btns = document.querySelectorAll('.option-btn');
            btns.forEach(b => b.classList.remove('selected'));
            btns[index].classList.add('selected');

            // Send to DB
            await submitAnswer(roomId, currentUser.uid, qId, index);
        }

        // Host Next Button
        document.getElementById('next-btn').addEventListener('click', async () => {
            const btn = document.getElementById('next-btn');
            btn.disabled = true;
            await nextQuestion(roomId, currentRoomData.currentQuestionIndex, currentRoomData.questionQueue.length);
            btn.disabled = false;
        });
    </script>
</body>

</html>