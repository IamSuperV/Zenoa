<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Mission - ZENOA</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body style="background: radial-gradient(circle at center, #111, #000); min-height: 100vh;">

    <div class="cinematic-container">
        <!-- TOP BAR -->
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding: 0 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <span id="category-badge" class="tier-badge"
                    style="background: rgba(255,255,255,0.1); border-color: var(--text-secondary); color: var(--text-primary);">LOADING...</span>
                <div style="height: 4px; width: 100px; background: rgba(255,255,255,0.1); border-radius: 2px;">
                    <div id="progress-bar-top"
                        style="height: 100%; width: 0%; background: var(--accent-color); box-shadow: 0 0 10px var(--accent-glow);">
                    </div>
                </div>
            </div>

            <div id="timer"
                style="font-family: monospace; font-size: 1.5rem; font-weight: 700; color: var(--danger-color); text-shadow: 0 0 10px var(--danger-color);">
                LIVE
            </div>
        </div>

        <!-- MAIN CARD -->
        <div class="question-card">
            <h2 id="scenario-text" class="scenario-text" style="color: #fff; margin-bottom: 2.5rem;">
                Initializing scenario parameters...
            </h2>

            <div id="options-container" style="display: flex; flex-direction: column; gap: 0.5rem;">
                <!-- JS Injected -->
            </div>

            <p id="error-msg"
                style="color: var(--danger-color); text-align: center; margin-top: 1rem; font-weight: 700;"></p>
        </div>

        <!-- CONTROLS -->
        <div id="next-btn-container"
            style="margin-top: 2rem; text-align: center; opacity: 0; transition: opacity 0.5s;">
            <button id="next-btn" class="btn btn-primary"
                style="padding: 1rem 4rem; font-size: 1.1rem; clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%);">
                CONFIRM & PROCEED
            </button>
        </div>

    </div>

    <script type="module">
        import { auth } from './js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { subscribeToGame, submitAnswer, nextQuestion } from './js/game.js';
        import { QUESTIONS_DB } from './js/data.js';

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');

        if (!roomId) window.location.href = 'dashboard.html';

        let currentUser = null;
        let currentRoomData = null;
        let localCurrentIndex = 0;
        let totalQuestions = 0;

        initGameListener();

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                currentUser = user;
                if (currentRoomData) {
                    renderQuestion(currentRoomData);
                }
            }
        });

        function initGameListener() {
            subscribeToGame(roomId, (roomData) => {
                if (!roomData) return;
                currentRoomData = roomData;
                totalQuestions = roomData.questionQueue ? roomData.questionQueue.length : 0;
                renderQuestion(roomData);
            });
        }

        function renderQuestion(roomData) {
            const index = localCurrentIndex;

            if (!roomData.questionQueue || roomData.questionQueue.length === 0) {
                document.getElementById('scenario-text').textContent = "Error: Empty mission parameters.";
                return;
            }

            if (index >= totalQuestions) {
                document.body.style.opacity = '0';
                setTimeout(() => { window.location.href = `results.html?roomId=${roomId}`; }, 500);
                return;
            }

            const qId = roomData.questionQueue[index];
            const question = QUESTIONS_DB.find(q => q.id === qId);

            if (!question) {
                document.getElementById('scenario-text').textContent = "Data corruption detected. Skip to next.";
                document.getElementById('next-btn-container').style.opacity = '1';
                return;
            }

            // Update UI
            document.getElementById('category-badge').textContent = question.category || "GENERAL";
            const progress = ((index + 1) / totalQuestions) * 100;
            document.getElementById('progress-bar-top').style.width = `${progress}%`;

            document.getElementById('scenario-text').textContent = question.scenario;

            // Checked saved answer
            let savedAnswer = undefined;
            if (currentUser && roomData.answers && roomData.answers[currentUser.uid]) {
                savedAnswer = roomData.answers[currentUser.uid][String(qId)];
            }

            // Options
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            question.options.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = opt;

                if (savedAnswer === i) {
                    btn.classList.add('selected');
                }

                btn.onclick = async () => {
                    if (!currentUser) return;

                    const allBtns = container.querySelectorAll('.option-btn');
                    allBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');

                    try {
                        await submitAnswer(roomId, currentUser.uid, qId, i);
                        document.getElementById('next-btn-container').style.opacity = '1';
                    } catch (e) {
                        document.getElementById('error-msg').textContent = "Transmission failed. Retry.";
                    }
                };
                container.appendChild(btn);
            });

            // Show next button if already answered, but here we can just hide/show based on interaction
            if (savedAnswer !== undefined) {
                document.getElementById('next-btn-container').style.opacity = '1';
            } else {
                document.getElementById('next-btn-container').style.opacity = '0';
            }
        }

        document.getElementById('next-btn').addEventListener('click', () => {
            // Animate out?
            const card = document.querySelector('.question-card');
            card.style.transform = "translateX(-20px)";
            card.style.opacity = "0";

            setTimeout(() => {
                localCurrentIndex++;
                renderQuestion(currentRoomData);
                card.style.transform = "translateX(0)";
                card.style.opacity = "1";
                window.scrollTo(0, 0);
            }, 300);
        });
    </script>
</body>

</html>