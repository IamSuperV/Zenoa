<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playing - ZENOA</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .option-btn {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            padding: 1rem;
            text-align: left;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
            font-size: 1rem;
            user-select: none;
            /* Prevent text selection on rapid clicks */
        }

        .option-btn:hover {
            background-color: var(--surface-hover);
            border-color: var(--accent-color);
        }

        .option-btn.selected {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container" style="max-width: 800px; padding-top: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div style="font-weight: 700; color: var(--text-secondary);">ZENOA</div>
            <div id="timer" style="font-variant-numeric: tabular-nums; font-weight: 700; font-size: 1.2rem;">Live</div>
        </div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <span id="category-badge"
                    style="background: var(--surface-hover); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; text-transform: uppercase;">...</span>
                <span id="progress-indicator">1 / 8</span>
            </div>

            <h2 id="scenario-text" style="font-size: 1.5rem; margin-bottom: 2rem; line-height: 1.4;">Loading scenario...
            </h2>

            <div id="options-container" style="display: flex; flex-direction: column; gap: 1rem;">
                <!-- Options injected here -->
            </div>
            <p id="error-msg" style="color: var(--danger-color); text-align: center; margin-top: 1rem;"></p>
        </div>

        <div id="next-btn-container" style="margin-top: 2rem; text-align: center;">
            <button id="next-btn" class="btn btn-primary" style="padding: 0.5rem 2rem;">Next Question</button>
        </div>
        <p id="waiting-msg" class="hidden"
            style="text-align: center; margin-top: 2rem; color: var(--text-secondary); font-style: italic;">Waiting for
            host...</p>
    </div>

    <script type="module">
        import { auth } from './js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { subscribeToGame, submitAnswer, nextQuestion } from './js/game.js';
        import { QUESTIONS_DB } from './js/data.js';

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');

        if (!roomId) window.location.href = 'dashboard.html';

        let currentUser = null;
        let currentRoomData = null;

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                currentUser = user;
                initGameListener();
            }
        });

        function initGameListener() {
            subscribeToGame(roomId, (roomData) => {
                if (!roomData) return;
                currentRoomData = roomData;

                if (roomData.status === 'finished') {
                    window.location.href = `results.html?roomId=${roomId}`;
                    return;
                }

                renderQuestion(roomData);
            });
        }

        let localCurrentIndex = 0;
        let totalQuestions = 0;

        function initGameListener() {
            subscribeToGame(roomId, (roomData) => {
                if (!roomData) return;
                currentRoomData = roomData;
                totalQuestions = roomData.questionQueue.length;

                // Sync: If room is just starting, ensure we are at 0 (or recover if reloaded)
                // We will use localCurrentIndex to drive the UI.

                // If game detects "finished" globally for everyone, maybe force end? 
                // No, let's keep it individual. 

                renderQuestion(roomData);
            });
        }

        function renderQuestion(roomData) {
            const index = localCurrentIndex;

            // Check if finished
            if (index >= totalQuestions) {
                window.location.href = `results.html?roomId=${roomId}`;
                return;
            }

            const qId = roomData.questionQueue[index];
            const question = QUESTIONS_DB.find(q => q.id === qId);

            if (!question) return;

            // Update UI Labels
            document.getElementById('category-badge').textContent = question.category;
            document.getElementById('progress-indicator').textContent = `${index + 1} / ${totalQuestions}`;
            document.getElementById('scenario-text').textContent = question.scenario;

            // Determine Selected Answer
            const userAnswers = roomData.answers && roomData.answers[currentUser.uid];
            // Ensure ID is string for lookup
            const savedAnswer = userAnswers ? userAnswers[String(qId)] : undefined;

            // Render Options
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            question.options.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = opt;

                // Active State
                if (savedAnswer === i) {
                    btn.classList.add('selected');
                }

                // Click Handler
                btn.onclick = async () => {
                    // Optimistic UI update
                    const allBtns = container.querySelectorAll('.option-btn');
                    allBtns.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');

                    try {
                        await submitAnswer(roomId, currentUser.uid, qId, i);
                        document.getElementById('error-msg').textContent = '';

                        // Auto-advance or Enable Next? 
                        // Let's enable the Next button logic.
                        // Actually, user clicked default next button before.
                        // We need a "Next" button for EVERYONE now.
                        document.getElementById('next-btn-container').classList.remove('hidden');
                    } catch (e) {
                        document.getElementById('error-msg').textContent = "Failed to save answer. Try again.";
                        btn.classList.remove('selected');
                    }
                };

                container.appendChild(btn);
            });
        }

        // Universal Next Button Logic
        const nextBtn = document.getElementById('next-btn');
        nextBtn.addEventListener('click', () => {
            localCurrentIndex++;
            // Force re-render with new index
            renderQuestion(currentRoomData);
            // Hide button until they answer next one (optional, but good UX)
            // But existing code showed it always in host controls.
            // We will keep it simple.
            window.scrollTo(0, 0);
        });
    </script>
</body>

</html>