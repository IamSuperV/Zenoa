<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Rankings - ZENOA</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@500;700&display=swap"
        rel="stylesheet">
    <style>
        /* --- RANKINGS PAGE OVERRIDES (Purple/Nebula Theme) --- */
        body {
            background-color: #0b0514;
            background-image:
                radial-gradient(circle at 50% 0%, rgba(120, 50, 255, 0.3) 0%, transparent 60%),
                radial-gradient(circle at 10% 20%, rgba(255, 50, 100, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(50, 100, 255, 0.1) 0%, transparent 40%),
                url('https://www.transparenttextures.com/patterns/stardust.png');
            background-attachment: fixed;
            font-family: 'Rajdhani', sans-serif;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        .rankings-header {
            text-align: center;
            margin-bottom: 1rem;
            position: relative;
            padding-top: 1rem;
        }

        .rankings-header h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            background: linear-gradient(180deg, #fff 20%, #cdb4db 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(180, 100, 255, 0.6);
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .crown-icon {
            font-size: 2rem;
            filter: drop-shadow(0 0 10px gold);
        }

        /* --- MAIN BOARD --- */
        .leaderboard-frame {
            background: rgba(20, 10, 35, 0.85);
            border: 1px solid rgba(130, 80, 255, 0.3);
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.6), inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .leaderboard-frame::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent, rgba(160, 100, 255, 0.8), transparent);
        }

        /* --- TABS (TIERS) --- */
        .tier-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            overflow-x: auto;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            scrollbar-width: none;
            /* Hide scrollbar */
        }

        .tier-tabs::-webkit-scrollbar {
            display: none;
        }

        .tier-tab {
            flex: 1;
            min-width: 80px;
            text-align: center;
            padding: 12px 0;
            font-size: 0.9rem;
            font-weight: 700;
            color: #888;
            cursor: pointer;
            text-transform: uppercase;
            position: relative;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .tier-tab.active {
            color: #fff;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .tier-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #cdb4db;
            box-shadow: 0 0 10px #cdb4db;
        }

        /* --- SUB-HEADER (Title + Toggle) --- */
        .list-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), transparent);
        }

        .current-tier-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #dec0f0;
        }

        .toggle-pill {
            display: flex;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2px;
            font-size: 0.75rem;
        }

        .toggle-opt {
            padding: 4px 12px;
            border-radius: 18px;
            cursor: pointer;
            color: #aaa;
            transition: all 0.2s;
        }

        .toggle-opt.active {
            background: rgba(60, 100, 255, 0.6);
            color: #fff;
            box-shadow: 0 0 10px rgba(60, 100, 255, 0.4);
        }

        /* --- LIST --- */
        .rank-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 1rem 1rem 1rem;
        }

        .rank-row {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin-bottom: 6px;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.03), rgba(0, 0, 0, 0.3));
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            transition: transform 0.1s;
        }

        /* Top 3 Styling */
        .rank-row.rank-1 {
            background: linear-gradient(90deg, rgba(255, 215, 0, 0.15), rgba(0, 0, 0, 0.3));
            border-left: 2px solid gold;
        }

        .rank-row.rank-2 {
            background: linear-gradient(90deg, rgba(192, 192, 192, 0.15), rgba(0, 0, 0, 0.3));
            border-left: 2px solid silver;
        }

        .rank-row.rank-3 {
            background: linear-gradient(90deg, rgba(205, 127, 50, 0.15), rgba(0, 0, 0, 0.3));
            border-left: 2px solid #cd7f32;
        }

        .r-rank {
            width: 40px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: #888;
            position: relative;
        }

        .rank-1 .r-rank {
            color: gold;
            font-size: 1.4rem;
            text-shadow: 0 0 10px gold;
        }

        .rank-2 .r-rank {
            color: silver;
            font-size: 1.3rem;
        }

        .rank-3 .r-rank {
            color: #cd7f32;
            font-size: 1.2rem;
        }

        .r-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            /* Circle avatar per reference */
            background: #111;
            border: 2px solid rgba(255, 255, 255, 0.1);
            margin: 0 1rem 0 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
        }

        .rank-1 .r-avatar {
            border-color: gold;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .r-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .r-name {
            font-weight: 700;
            font-size: 1rem;
            color: #fff;
            line-height: 1.2;
        }

        .r-sub {
            font-size: 0.75rem;
            color: #888;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .r-score {
            text-align: right;
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .diamond-icon {
            width: 16px;
            height: 16px;
            filter: drop-shadow(0 0 5px cyan);
        }

        /* --- FOOTER (Current User) --- */
        .user-footer {
            background: rgba(10, 5, 20, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            position: relative;
            z-index: 10;
        }

        .footer-row {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .footer-actions {
            display: flex;
            gap: 1rem;
        }

        .f-btn {
            flex: 1;
            padding: 0.8rem;
            border-radius: 6px;
            border: none;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 0.9rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            transition: transform 0.1s;
        }

        .f-btn-profile {
            background: linear-gradient(180deg, #443366 0%, #221144 100%);
            color: #dcb4ff;
            border: 1px solid #554477;
        }

        .f-btn-challenge {
            background: linear-gradient(180deg, #ff8833 0%, #cc5500 100%);
            color: #fff;
            border: 1px solid #ff7722;
            box-shadow: 0 0 15px rgba(255, 100, 0, 0.3);
        }

        /* --- MOBILE --- */
        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
                height: 100vh;
            }

            .rankings-header h1 {
                font-size: 2rem;
            }

            .tier-tab {
                min-width: 60px;
                font-size: 0.8rem;
            }

            .r-avatar {
                width: 40px;
                height: 40px;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- TOP HEADER -->
        <div class="rankings-header">
            <a href="dashboard.html"
                style="position: absolute; left: 0; top: 1rem; color: #fff; text-decoration: none; opacity: 0.7; font-size: 0.9rem;">â—„
                BACK</a>
            <h1><span class="crown-icon">ðŸ‘‘</span> Rankings</h1>
        </div>

        <!-- MAIN FRAME -->
        <div class="leaderboard-frame">
            <!-- TABS -->
            <div class="tier-tabs" id="tier-tab-container">
                <div class="tier-tab" data-tier="LEGEND">Legend</div>
                <div class="tier-tab" data-tier="CHAMPION">Champion</div>
                <div class="tier-tab" data-tier="PLATINUM">Platinum</div>
                <div class="tier-tab" data-tier="GOLD">Gold</div>
                <div class="tier-tab active" data-tier="ALL">Global</div> <!-- Default -->
            </div>

            <!-- CONTROLS -->
            <div class="list-controls">
                <div class="current-tier-title">
                    <img src="assets/tiers/platinum.png" class="tier-icon-sm" id="current-tier-icon"
                        style="display:none;">
                    <span id="current-view-label">Global Rankings</span>
                </div>
                <div class="toggle-pill">
                    <div class="toggle-opt active" id="toggle-global" onclick="switchScope('Global')">Global</div>
                    <div class="toggle-opt" id="toggle-local" onclick="switchScope('Local')">Local</div>
                </div>
            </div>

            <!-- SCROLLABLE LIST -->
            <div class="rank-list" id="rank-list">
                <!-- Rows injected here -->
                <div style="text-align: center; padding: 3rem; color: #888;">Scanning Neural Network...</div>
            </div>

            <!-- FOOTER TOOLBAR -->
            <div class="user-footer" id="user-footer">
                <div class="footer-row">
                    <div class="r-rank" style="color: #fff;">#--</div>
                    <div class="r-avatar">ðŸ‘¤</div>
                    <div class="r-info">
                        <div class="r-name" id="my-name">Guest</div>
                        <div class="r-sub">
                            <div
                                style="width: 100px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin-right: 5px;">
                                <div
                                    style="width: 60%; height: 100%; background: #00f3ff; box-shadow: 0 0 5px #00f3ff;">
                                </div>
                            </div>
                            Level --
                        </div>
                    </div>
                    <div class="r-score">
                        ðŸ’Ž <span id="my-score">---</span>
                    </div>
                </div>
                <div class="footer-actions">
                    <button class="f-btn f-btn-profile" onclick="window.location.href='profile.html'">View
                        Profile</button>
                    <button class="f-btn f-btn-challenge">Challenge</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden native filter for logic compatibility -->
    <div id="filter-container" class="hidden">
        <select id="filter-select"></select>
    </div>

    <script type="module">
        import { subscribeToLeaderboard } from './js/leaderboard.js';
        import { generateFakeUsers, INDIAN_COLLEGES, INDIAN_CITIES } from './js/fake_users.js';

        let currentScope = 'Global';
        let currentTierFilter = 'ALL';
        let unsubscribe = null;
        let allUsersCache = []; // Store fetched users to filter client-side

        // Generate dataset
        const FAKE_DATABASE = generateFakeUsers();

        // Init
        initBoard('Global');

        // Scope Switcher
        window.switchScope = (scope) => {
            currentScope = scope;
            document.getElementById('toggle-global').className = scope === 'Global' ? 'toggle-opt active' : 'toggle-opt';
            document.getElementById('toggle-local').className = scope === 'Local' ? 'toggle-opt active' : 'toggle-opt';

            if (scope === 'Local') {
                // For demo, just pick a random college or prompt
                // In real app, this would use user's profile location.
                // We'll simulate by picking a City
                initBoard('City', 'Mumbai');
                document.getElementById('current-view-label').textContent = "Mumbai Sector";
            } else {
                initBoard('Global');
                document.getElementById('current-view-label').textContent = "Global Rankings";
            }
        };

        // Tier Tabs
        document.querySelectorAll('.tier-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                // Update UI
                document.querySelectorAll('.tier-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');

                // Update Filter
                currentTierFilter = e.target.dataset.tier;
                renderCache(); // Re-render with new filter
            });
        });

        function initBoard(type, filterVal = null) {
            const list = document.getElementById('rank-list');
            list.innerHTML = '<div style="text-align: center; padding: 3rem; opacity: 0.5;">Uplink Established. Syncing...</div>';

            if (unsubscribe) unsubscribe();

            unsubscribe = subscribeToLeaderboard(type, filterVal, 'totalScore', (realUsers) => {
                // Merge Data
                let fakeSubset = FAKE_DATABASE;
                if (type === 'City' && filterVal) fakeSubset = FAKE_DATABASE.filter(u => u.city === filterVal);

                const normalizedReal = realUsers.map(u => ({ ...u, score: u.displayScore || 0, isReal: true }));
                const normalizedFake = fakeSubset.map(u => ({ ...u, displayScore: u.score || 0 }));

                allUsersCache = [...normalizedReal, ...normalizedFake].sort((a, b) => b.score - a.score).slice(0, 100);

                renderCache();
            });
        }

        function renderCache() {
            const list = document.getElementById('rank-list');
            list.innerHTML = '';

            // Filter by Tier if not ALL
            let filtered = allUsersCache;
            if (currentTierFilter !== 'ALL') {
                filtered = allUsersCache.filter(u => (u.tier || 'BRONZE') === currentTierFilter);
            }

            if (filtered.length === 0) {
                list.innerHTML = `<div style="text-align: center; padding: 3rem; color: #666;">No operatives in ${currentTierFilter} tier.</div>`;
                return;
            }

            filtered.forEach((u, index) => {
                const rank = index + 1;
                const tier = u.tier || 'BRONZE';
                const level = Math.floor((u.score || u.displayScore) / 100) || 1;

                const div = document.createElement('div');
                div.className = `rank-row rank-${rank}`;
                div.innerHTML = `
                    <div class="r-rank">${rank}</div>
                    <div class="r-avatar">
                        <img src="assets/tiers/${tier.toLowerCase()}.png" style="width: 100%; height: 100%; border-radius: 50%; padding: 2px;">
                    </div>
                    <div class="r-info">
                        <div class="r-name">${u.username}</div>
                        <div class="r-sub">Level ${level} â€¢ ${tier}</div>
                    </div>
                    <div class="r-score">
                        <span>ðŸ’Ž</span> ${Math.floor(u.score || u.displayScore)}
                    </div>
                `;
                list.appendChild(div);
            });

            // Update Footer (Simulated logic for "Me" if real user found, else static)
            // Ideally we find the real user in the list
            const foundMe = allUsersCache.find(u => u.isReal); // Assuming generic check
            if (foundMe) {
                document.getElementById('my-name').textContent = foundMe.username;
                document.getElementById('my-score').textContent = Math.floor(foundMe.score);
            }
        }
    </script>
</body>

</html>