<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - ZENOA</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .filter-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .filter-btn.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }
    </style>
</head>

<body>
    <div class="container">
        <header
            style="display: flex; justify-content: space-between; align-items: center; padding: 2rem 0; border-bottom: 1px solid var(--border-color);">
            <div style="font-weight: 700; font-size: 1.5rem;">ZENOA</div>
            <nav style="display: flex; gap: 1rem;">
                <a href="dashboard.html" class="btn btn-secondary"
                    style="padding: 0.5rem 1rem; font-size: 0.9rem;">Dashboard</a>
            </nav>
        </header>

        <main style="padding-top: 3rem; max-width: 800px; margin: 0 auto;">
            <h1 style="text-align: center; margin-bottom: 2rem;">Global Rankings</h1>

            <div
                style="display: flex; justify-content: center; gap: 2rem; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color);">
                <button class="filter-btn active" id="tab-global" onclick="switchTab('Global')">Global</button>
                <button class="filter-btn" id="tab-college" onclick="switchTab('College')">My College</button>
                <button class="filter-btn" id="tab-city" onclick="switchTab('City')">My City</button>
            </div>

            <div class="card">
                <div id="loading-msg" style="text-align: center; color: var(--text-secondary);">Loading rankings...
                </div>
                <div id="leaderboard-list">
                    <!-- Injected via JS -->
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { auth } from './js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getGlobalLeaderboard } from './js/leaderboard.js';
        import { getUserProfile } from './js/auth.js';

        let currentUser = null;
        let userProfile = null;
        let currentTab = 'Global';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                userProfile = await getUserProfile(user.uid);
                loadRankings('Global');
            } else {
                // Allow viewing global even if not logged in (optional, but let's encourage login for context)
                loadRankings('Global');
            }
        });

        window.switchTab = (tab) => {
            currentTab = tab;
            // UI Toggle
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab.toLowerCase()}`).classList.add('active');

            loadRankings(tab);
        };

        async function loadRankings(type) {
            const list = document.getElementById('leaderboard-list');
            const loader = document.getElementById('loading-msg');

            list.innerHTML = '';
            loader.style.display = 'block';

            let filterValue = null;
            if (type === 'College') {
                if (!userProfile) {
                    loader.textContent = "Log in to see College rankings.";
                    return;
                }
                filterValue = userProfile.college;
            } else if (type === 'City') {
                if (!userProfile) {
                    loader.textContent = "Log in to see City rankings.";
                    return;
                }
                filterValue = userProfile.city || "Unknown";
            }

            try {
                const rankings = await getGlobalLeaderboard(type, filterValue);
                loader.style.display = 'none';

                if (rankings.length === 0) {
                    list.innerHTML = `<p style="text-align: center; color: var(--text-secondary);">No ranked players found in this category yet.</p>`;
                    return;
                }

                rankings.forEach((p, idx) => {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.justify - content = 'space-between';
                    div.style.alignItems = 'center';
                    div.style.padding = '1rem';
                    div.style.borderBottom = '1px solid var(--border-color)';

                    // Highlight self
                    if (currentUser && p.uid === currentUser.uid) {
                        div.style.background = 'var(--surface-hover)';
                        div.style.borderLeft = '3px solid var(--accent-color)';
                    }

                    div.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-weight: 700; color: var(--text-secondary); width: 30px;">#${idx + 1}</span>
                            <div>
                                <div style="font-weight: 600;">${p.username}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    ${p.dominantType || 'Unranked'} â€¢ ${p.college || 'Unknown'}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: var(--accent-color);">${p.totalScore}</div>
                            <div style="font-size: 0.7rem; text-transform: uppercase;">Total Score</div>
                        </div>
                    `;
                    list.appendChild(div);
                });

            } catch (error) {
                console.error(error);
                loader.textContent = "Failed to load rankings.";
            }
        }
    </script>
</body>

</html>