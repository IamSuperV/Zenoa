<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Lobby - ZENOA</title>
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="overlay"></div>
    <div class="container" style="max-width: 1000px; padding-top: 4rem;">

        <!-- HEADER / CODE -->
        <div style="text-align: center; margin-bottom: 4rem;">
            <a href="index.html" style="text-decoration: none;">
                <div class="badge badge-tier-gold"
                    style="font-size: 0.8rem; margin-bottom: 1rem; animation: float 3s ease-in-out infinite; cursor: pointer;">
                    MISSION BRIEFING
                </div>
                <div
                    style="font-family: var(--font-display); font-size: 1.2rem; color: var(--text-secondary); margin-bottom: 0.5rem; letter-spacing: 4px; cursor: pointer;">
                    SECURE CHANNEL ESTABLISHED</div>
            </a>

            <div class="room-code-display" id="room-code-display"
                style="font-family: var(--font-display); font-size: 5rem; color: var(--gold-primary); text-shadow: 0 0 30px var(--gold-glow); letter-spacing: 10px; margin: 1rem 0;">
                ...</div>

            <div class="flex-center" style="gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="copy-btn" style="min-width: 200px;">
                    COPY UPLINK
                </button>
                <a href="dashboard.html" class="btn btn-secondary"
                    style="min-width: 200px; text-decoration: none; text-align: center; border-color: var(--text-muted); color: var(--text-muted);">
                    ABORT / RETURN
                </a>
                <input type="text" id="share-link" readonly style="position: absolute; left: -9999px;">
            </div>

            <div id="connection-status"
                style="margin-top: 1.5rem; font-family: var(--font-ui); color: var(--neon-blue); text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem;">
                <span class="text-neon" style="animation: glow-pulse 2s infinite;">‚óè</span> AWAITING CONNECTION...
            </div>
        </div>

        <div class="card-glass"
            style="min-height: 500px; display: flex; flex-direction: column; border-color: var(--glass-highlight);">
            <div class="flex-between"
                style="border-bottom: 1px solid var(--glass-border); padding-bottom: 1.5rem; margin-bottom: 2rem;">
                <h3 style="margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
                    OPERATIVES <span id="player-count"
                        style="color: var(--neon-blue); background: rgba(0, 243, 255, 0.1); padding: 2px 10px; border-radius: 4px; font-size: 1rem;">(0)</span>
                </h3>
                <div id="waiting-msg"
                    style="font-family: var(--font-ui); color: var(--text-secondary); letter-spacing: 1px; text-transform: uppercase;">
                    WAITING FOR COMMANDER...
                </div>
            </div>

            <!-- Player Grid -->
            <div id="players-list" class="grid-2"
                style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); align-content: start; gap: 1.5rem;">
                <!-- JS Injected -->
            </div>

            <div style="margin-top: auto; padding-top: 3rem;">
                <div id="host-controls" class="hidden">
                    <button id="start-game-btn" class="btn btn-primary"
                        style="width: 100%; padding: 1.5rem; font-size: 1.5rem;">
                        INITIATE MISSION SEQUENCE
                    </button>
                    <p
                        style="text-align: center; margin-top: 1rem; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                        Commander Authority Required
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- City Prompt Modal -->
    <div id="city-modal" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(10px); z-index: 100; display: flex; align-items: center; justify-content: center;">
        <div class="card-glass"
            style="width: 90%; max-width: 450px; text-align: center; border: 1px solid var(--neon-blue); box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);">
            <h2 class="text-neon" style="margin-bottom: 1rem;">IDENTIFY SECTOR</h2>
            <p style="margin-bottom: 2rem; color: var(--text-secondary);">Enter your base of operations for the global
                hierarchy.</p>
            <input type="text" id="city-input" placeholder="REGION / CITY"
                style="margin-bottom: 2rem; text-align: center; font-size: 1.2rem; letter-spacing: 2px; text-transform: uppercase; border-color: var(--neon-blue);">
            <button id="save-city-btn" class="btn btn-neon" style="width: 100%;">CONFIRM IDENTITY</button>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdown-overlay" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
        <h1
            style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 4rem; letter-spacing: 10px; animation: float 2s ease-in-out infinite;">
            MISSION LAUNCH
        </h1>
        <div id="countdown-timer"
            style="font-family: var(--font-display); font-size: 15rem; font-weight: 900; color: var(--gold-primary); text-shadow: 0 0 100px var(--gold-glow); line-height: 1;">
            3
        </div>
    </div>

    <script type="module">
        import { auth, db } from './js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { subscribeToRoom, startGame } from './js/rooms.js';

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');

        if (!roomId) window.location.href = 'dashboard.html';

        document.getElementById('room-code-display').textContent = roomId;
        document.getElementById('share-link').value = window.location.href;

        // Copy Link
        document.getElementById('copy-btn').addEventListener('click', () => {
            const copyText = document.getElementById("share-link");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value);

            const btn = document.getElementById('copy-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span style="color: var(--neon-blue);">UPLINK COPIED</span>';
            setTimeout(() => { btn.innerHTML = originalText; }, 2000);
        });

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
            } else {
                currentUser = user;
                await checkCity(user.uid);
                initRoomListener();
            }
        });

        async function checkCity(uid) {
            const userRef = doc(db, "users", uid);
            const snap = await getDoc(userRef);
            if (snap.exists()) {
                const data = snap.data();
                if (!data.city || data.city === "Unknown") {
                    const modal = document.getElementById('city-modal');
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex'; // Flex override

                    document.getElementById('save-city-btn').addEventListener('click', async () => {
                        const cityVal = document.getElementById('city-input').value.trim();
                        if (cityVal) {
                            await updateDoc(userRef, { city: cityVal });
                            modal.classList.add('hidden');
                            modal.style.display = 'none';
                        }
                    });
                }
            }
        }

        function initRoomListener() {
            const statusEl = document.getElementById('connection-status');

            subscribeToRoom(roomId, (roomData) => {
                statusEl.innerHTML = `<span class="text-neon">‚óè</span> ENCRYPTED LINK ACTIVE`;
                statusEl.style.color = "var(--neon-blue)";

                if (!roomData) {
                    alert("Room terminated.");
                    window.location.href = 'dashboard.html';
                    return;
                }

                if (roomData.status === 'playing') {
                    launchCountdown();
                    return;
                }

                // Players
                const list = document.getElementById('players-list');
                list.innerHTML = '';
                document.getElementById('player-count').textContent = `(${roomData.players.length})`;

                roomData.players.forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'card-glass';
                    el.style.padding = '1.5rem';
                    el.style.textAlign = 'center';
                    el.style.transition = 'all 0.3s';

                    if (p.uid === currentUser.uid) {
                        el.style.borderColor = 'var(--gold-primary)';
                        el.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.2)';
                    }
                    if (p.uid === roomData.hostId) {
                        // Host styling
                    }

                    // Avatar placeholder
                    el.innerHTML = `
                        <div style="font-size: 2.5rem; margin-bottom: 1rem;">üë§</div>
                        <div style="font-weight: 700; font-size: 1.1rem; color: #fff; margin-bottom: 0.2rem;">${p.username}</div>
                        ${p.uid === roomData.hostId ? '<div class="badge badge-tier-gold" style="font-size: 0.6rem;">COMMANDER</div>' : '<div class="badge" style="border: 1px solid var(--text-secondary); color: var(--text-secondary); font-size: 0.6rem;">OPERATIVE</div>'}
                    `;

                    list.appendChild(el);
                });

                // Host Controls
                if (currentUser.uid === roomData.hostId) {
                    document.getElementById('host-controls').classList.remove('hidden');
                    document.getElementById('waiting-msg').innerHTML = '<span class="text-gold" style="animation: pulse 1s infinite;">AWAITING YOUR COMMAND</span>';
                    document.getElementById('start-game-btn').disabled = false;
                    document.getElementById('start-game-btn').innerHTML = "INITIATE MISSION SEQUENCE";
                } else {
                    document.getElementById('host-controls').classList.add('hidden');
                    document.getElementById('waiting-msg').innerHTML = 'WAITING FOR COMMANDER...';
                }
            });
        }

        let countdownTriggered = false;
        function launchCountdown() {
            if (countdownTriggered) return;
            countdownTriggered = true;

            const overlay = document.getElementById('countdown-overlay');
            const timer = document.getElementById('countdown-timer');
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';

            let count = 3;
            timer.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    timer.textContent = count;
                } else {
                    clearInterval(interval);
                    timer.textContent = "GO";
                    timer.style.color = "#fff";
                    setTimeout(() => {
                        window.location.href = `play.html?roomId=${roomId}`;
                    }, 500);
                }
            }, 1000);
        }

        document.getElementById('start-game-btn').addEventListener('click', async () => {
            const btn = document.getElementById('start-game-btn');
            btn.disabled = true;
            btn.innerHTML = "INITIALIZING...";
            try {
                await startGame(roomId);
            } catch (e) {
                console.error(e);
                btn.disabled = false;
                btn.innerHTML = "INITIATE MISSION SEQUENCE";
                alert("Launch Failed: " + e.message);
            }
        });
    </script>
</body>

</html>