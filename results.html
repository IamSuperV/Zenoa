<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results - ZENOA</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container" style="max-width: 900px; padding-top: 3rem;">
        <h1 style="text-align: center; margin-bottom: 2rem;">Match Report</h1>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
            <!-- Personal Card -->
            <div class="card">
                <h2>Your Analysis</h2>
                <div id="dominant-hero"
                    style="font-size: 2rem; color: var(--accent-color); font-weight: 700; margin-bottom: 0.5rem;">
                    Calculating...</div>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Based on your decisions in this session.
                </p>

                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="stat-row">
                        <span>Logical</span> <span id="r-logical">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Strategic</span> <span id="r-strategic">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Social</span> <span id="r-social">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Political</span> <span id="r-political">0</span>
                    </div>
                    <div class="stat-row">
                        <span>Adaptive</span> <span id="r-adaptive">0</span>
                    </div>
                </div>

                <div id="new-badges" style="margin-top: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
            </div>

            <!-- Leaderboard Card -->
            <div class="card">
                <h2>Room Rankings</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Relative performance.</p>
                <div id="leaderboard-list" style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- List items -->
                </div>
            </div>
        </div>

        <div style="text-align: center;">
            <a href="dashboard.html" class="btn btn-primary">Return to Dashboard</a>
        </div>
    </div>

    <style>
        .stat-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .rank-item {
            background: var(--surface-hover);
            padding: 1rem;
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank-pos {
            font-weight: 700;
            margin-right: 1rem;
            color: var(--text-secondary);
        }
    </style>

    <script type="module">
        import { auth } from './js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { calculateAndSaveResults, getRoomLeaderboard } from './js/leaderboard.js';

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');

        if (!roomId) window.location.href = 'dashboard.html';

        let hasCalculated = false;

        onAuthStateChanged(auth, async (user) => {
            if (user && !hasCalculated) {
                hasCalculated = true; // Prevent double calc

                // 1. Calculate & Save My Results
                const myResults = await calculateAndSaveResults(roomId, user.uid);

                if (myResults) {
                    document.getElementById('dominant-hero').textContent = myResults.dominantType;
                    document.getElementById('r-logical').textContent = myResults.stats.logical || 0;
                    document.getElementById('r-strategic').textContent = myResults.stats.strategic || 0;
                    document.getElementById('r-social').textContent = myResults.stats.social || 0;
                    document.getElementById('r-political').textContent = myResults.stats.political || 0;
                    document.getElementById('r-adaptive').textContent = myResults.stats.adaptive || 0;

                    if (myResults.badges.length > 0) {
                        const bag = document.getElementById('new-badges');
                        myResults.badges.forEach(b => {
                            const sp = document.createElement('span');
                            sp.textContent = `+ ${b}`;
                            sp.style.background = 'var(--success-color)';
                            sp.style.color = 'black';
                            sp.style.padding = '2px 8px';
                            sp.style.borderRadius = '4px';
                            sp.style.fontSize = '0.8rem';
                            bag.appendChild(sp);
                        });
                    }
                }

                // 2. Fetch Leaderboard
                const leaderboard = await getRoomLeaderboard(roomId);
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '';

                leaderboard.forEach((p, idx) => {
                    const div = document.createElement('div');
                    div.className = 'rank-item';

                    // Highlight self
                    if (p.uid === user.uid) {
                        div.style.border = '1px solid var(--accent-color)';
                    }

                    div.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <span class="rank-pos">#${idx + 1}</span>
                            <div>
                                <div style="font-weight:600;">${p.username}</div>
                                <div style="font-size:0.8rem; color:var(--text-secondary);">${p.dominantType}</div>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end;">
                            <div style="font-weight:700;">${p.score} pts</div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        });
    </script>
</body>

</html>