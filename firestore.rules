rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // --- USERS COLLECTION ---
    // Anyone can read (for leaderboards), but only the owner can write.
    match /users/{userId} {
      allow read: if true;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if false; // Prevent anyone from deleting accounts via Client SDK
    }

    // --- ROOMS COLLECTION ---
    match /rooms/{roomId} {
      // Anyone can read a room to join it
      allow read: if true;
      
      // Only signed-in users can create rooms
      allow create: if isSignedIn();
      
      // Only signed-in users can update rooms (e.g. submitting answers, joining)
      // Ideally, we would check if the user is IN the room, but for MVP this restricts to valid users.
      allow update: if isSignedIn();
      
      // Prevent deleting rooms from client (optional, or allow Host only)
      allow delete: if false; 
    }
  }
}
