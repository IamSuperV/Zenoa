<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Zenoa</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="js/guard.js"></script>
    <style>
        .hidden {
            display: none !important;
        }

        .meter-container {
            margin-bottom: 1.5rem;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container flex justify-between items-center">
            <a href="index.html" class="nav-logo">ZENOA</a>
            <div class="flex items-center gap-6">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="rooms.html" class="nav-link">Rooms</a>
                <button id="logoutBtn"
                    class="text-sm text-danger font-bold hover:text-white transition-colors border-l border-glass pl-6">LOGOUT</button>
            </div>
        </div>
    </nav>

    <main class="container p-4 mt-8">
        <div id="loadingState" class="text-center p-12 text-muted animate-pulse">Retrieving personnel file...</div>

        <!-- PROFILE CONTENT -->
        <div id="profileContent" class="grid grid-3 hidden">
            <!-- User Info Sidebar -->
            <div class="card text-center p-8 border-glass bg-opacity-40">
                <div class="avatar mx-auto mb-6 shadow-lg shadow-primary/20" id="profileAvatar"
                    style="width: 120px; height: 120px; font-size: 2.5rem; border: 4px solid rgba(255,255,255,0.1);">--
                </div>

                <h1 class="text-2xl mb-1 text-glow" id="profileName">...</h1>
                <p class="mb-4 text-primary text-sm uppercase tracking-wider font-bold" id="profileMeta">--</p>

                <div class="badge tier-rookie mb-8 scale-110" id="profileTierBadge">--</div>

                <div class="border-t border-glass pt-6 mb-6">
                    <h4 class="text-left text-xs uppercase text-muted mb-4 tracking-widest">Decision DNA</h4>
                    <div class="flex flex-wrap gap-2 justify-center" id="decisionTags">
                        <span class="text-xs text-muted italic">Awaiting assessment data...</span>
                    </div>
                </div>

                <div class="flex flex-col gap-2 mt-auto">
                    <a href="settings.html" class="btn btn-secondary w-full justify-center text-xs">Edit Settings</a>
                </div>
            </div>

            <!-- Detailed Stats -->
            <div class="card p-8" style="grid-column: span 2;">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-xl">Cognitive Metrics</h3>
                    <div class="text-xs text-success" id="systemOnline" class="hidden">‚óè System Online</div>
                </div>

                <div id="metricsContainer" class="hidden">
                    <div class="grid grid-2 gap-12 mb-12">
                        <div class="p-6 bg-white bg-opacity-5 rounded-lg border border-glass">
                            <h4 class="text-sm text-muted uppercase mb-6">Performance Indices</h4>

                            <div class="meter-container">
                                <div class="flex justify-between mb-2">
                                    <span class="text-sm font-bold">Consistency</span>
                                    <span class="text-xs text-muted">Calculating...</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: 0%; background: var(--tier-apex);"></div>
                                </div>
                            </div>

                            <!-- More meters can be added when backend supports them -->
                            <p class="text-xs text-muted italic mt-4">* Meters calibrate after 5 matches.</p>
                        </div>

                        <div
                            class="flex flex-col justify-center items-center p-6 bg-white bg-opacity-5 rounded-lg border border-glass text-center">
                            <div class="text-4xl mb-4">üíé</div>
                            <h4 class="text-lg font-bold mb-2">Premium Status</h4>
                            <p class="text-sm text-muted">Unlock Pro features to view advanced analytics and deep-dive
                                comparisons.</p>
                            <button class="btn btn-secondary mt-4 text-xs" disabled>Coming Soon</button>
                        </div>
                    </div>

                    <h3 class="mb-6 text-lg">Mission History</h3>
                    <div class="overflow-hidden rounded-lg border border-glass">
                        <table class="table">
                            <thead>
                                <tr class="bg-white bg-opacity-5">
                                    <th class="text-xs pl-6">Scenario</th>
                                    <th class="text-xs">Category</th>
                                    <th class="text-xs text-right pr-6">Result</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="emptyMetrics"
                    class="text-center p-12 border border-glass border-dashed rounded-lg bg-white bg-opacity-5 hidden">
                    <div class="text-4xl mb-4 grayscale opacity-50">üìä</div>
                    <p class="text-muted mb-6">No data available. Complete your first assessment to unlock metrics.</p>
                    <a href="play.html" class="btn btn-primary">Start Assessment</a>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth } from './js/firebase.js';
        import { logoutUser } from './js/auth.js';
        import { getUserStats, getUserProfile } from './js/data.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        document.getElementById('logoutBtn').addEventListener('click', logoutUser);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const stats = await getUserStats(user.uid);
                const profile = await getUserProfile(user.uid);

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('profileContent').classList.remove('hidden');

                // Basic Info
                const name = profile?.displayName || user.email.split('@')[0];
                document.getElementById('profileName').textContent = name;
                document.getElementById('profileAvatar').textContent = name.substring(0, 2).toUpperCase();

                // Stats Logic
                if (stats && stats.matchesPlayed > 0) {
                    document.getElementById('metricsContainer').classList.remove('hidden');
                    document.getElementById('emptyMetrics').classList.add('hidden');
                    if (document.getElementById('systemOnline')) document.getElementById('systemOnline').classList.remove('hidden');

                    let tier = "Rookie";
                    let tierColor = "var(--tier-rookie)";
                    if (stats.sr > 1200) { tier = "Challenger"; tierColor = "var(--tier-challenger)"; }
                    if (stats.sr > 1500) { tier = "Strategist"; tierColor = "var(--tier-strategist)"; }
                    if (stats.sr > 2000) { tier = "Architect"; tierColor = "var(--tier-architect)"; }

                    document.getElementById('profileMeta').textContent = `${tier} ‚Ä¢ Level ${Math.floor(stats.matchesPlayed / 5) + 1}`;
                    document.getElementById('profileMeta').style.color = tierColor;

                    const tierBadge = document.getElementById('profileTierBadge');
                    tierBadge.textContent = tier;
                    tierBadge.className = `badge tier-${tier.toLowerCase()} mb-8 scale-110`;
                    tierBadge.style.boxShadow = `0 0 15px ${tierColor}`;

                    // Populate Decision Tags
                    if (stats.decisionStyles) {
                        const container = document.getElementById('decisionTags');
                        container.innerHTML = '';
                        [...new Set(stats.decisionStyles)].forEach(style => {
                            container.innerHTML += `<span class="tag-decision highlight capitalize bg-white bg-opacity-10 border-glass">${style}</span>`;
                        });
                    }

                    // Dummy History (Ideally this should be fetched too, but for now we are rigorous about stats)
                    // If no history collection exists, we can leave this empty or show the last played style
                    const lastStyle = stats.decisionStyles[stats.decisionStyles.length - 1] || 'Unknown';
                    document.getElementById('historyTableBody').innerHTML = `
                         <tr class="hover:bg-white hover:bg-opacity-5 transition-colors">
                            <td class="pl-6 font-bold">Latest Assessment</td>
                            <td><span class="badge tier-architect text-[0.65rem] opacity-70">General</span></td>
                            <td class="text-right pr-6"><span class="tag-decision capitalize text-xs">${lastStyle}</span></td>
                        </tr>
                    `;

                } else {
                    // Empty User
                    document.getElementById('metricsContainer').classList.add('hidden');
                    document.getElementById('emptyMetrics').classList.remove('hidden');
                    document.getElementById('profileMeta').textContent = "Cadet";
                    document.getElementById('profileTierBadge').textContent = "Unranked";
                    document.getElementById('profileTierBadge').className = `badge tier-rookie mb-8 scale-110`;
                }
            }
        });
    </script>
</body>

</html>