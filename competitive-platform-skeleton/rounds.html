<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Round Summary - Zenoa</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module" src="js/guard.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container flex justify-between items-center">
            <span class="font-bold">Scenario Complete</span>
            <div class="flex gap-4">
                <a href="play.html" class="btn btn-primary">Next Scenario</a>
            </div>
        </div>
    </nav>

    <main class="container p-8 flex flex-col items-center">
        <div class="badge bg-blue-50 text-blue-700 mb-4 px-4 py-2 text-lg border border-blue-100">Decision Recorded
        </div>

        <h2 class="mb-8">Cohort Alignment</h2>
        <p class="text-muted mb-4">Comparing against top scenarios this week.</p>

        <div class="card w-full max-w-lg p-0 overflow-hidden">
            <table class="table">
                <tbody id="cohortTable">
                    <tr>
                        <td class="p-4 text-center">Loading cohort data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script type="module">
        import { auth } from './js/firebase.js';
        import { getLeaderboard } from './js/data.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        async function loadCohort() {
            // Using leaderboard as a proxy for "Cohort"
            const data = await getLeaderboard();
            const container = document.getElementById('cohortTable');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<tr><td class="p-4 text-center">No other players found yet.</td></tr>';
                return;
            }

            // Show Top 5 Real Users
            const topUsers = data.slice(0, 5);

            topUsers.forEach((user, i) => {
                // Use REAL decision styles from their profile if available, else "Unknown"
                // We don't want to fake it anymore.
                const lastStyle = (user.decisionStyles && user.decisionStyles.length > 0)
                    ? user.decisionStyles[user.decisionStyles.length - 1]
                    : "Unranked";

                const isMe = auth.currentUser && auth.currentUser.uid === user.id;
                const displayName = isMe ? "You" : `Player ${user.id.substring(0, 4)}`;

                container.innerHTML += `
                    <tr style="${isMe ? 'background: #f8fafc;' : ''}">
                        <td class="w-8 font-bold">${i + 1}</td>
                        <td>
                            <div class="flex items-center gap-2">
                                <div class="avatar w-6 h-6 text-xs" style="background: ${isMe ? 'var(--primary-color)' : '#94a3b8'};">
                                    ${displayName.substring(0, 1)}
                                </div>
                                ${displayName}
                            </div>
                        </td>
                        <td class="text-right font-bold"><span class="tag-decision capitalize">${lastStyle}</span></td>
                    </tr>
                 `;
            });
        }

        onAuthStateChanged(auth, (user) => {
            if (user) loadCohort();
        });
    </script>
</body>

</html>